@{
    ViewBag.Title = "Detalle";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@model SistemaGestionCotizaciones.Models.SimulacionCotizacion
@using System.Data;
@using System.Web.Script.Serialization;
@using ExtensionMethods;

@{JavaScriptSerializer jss = new JavaScriptSerializer();}

<script>

    var ComponenteJson = [];
    var ServicioJson = [];
    var MontoServicioJson = [];
    var InfoSimulacion = [];

    $(document).ready(function () {

        
        var InfoSimulacion = @Html.Raw(jss.Serialize(Model.simulacionJson));
        var Servicios = @Html.Raw(jss.Serialize(Model.serviciosJson));
        var PlantillaSubservicios2 = @Html.Raw(jss.Serialize(Model.plantillasubservicios2Json));
        var ParametrosGenerales = @Html.Raw(jss.Serialize(Model.parametrosGeneralesJson));
        var familiasJson = @Html.Raw(jss.Serialize(Model.familiasJson));
        var contadorServicio;
        var seleccion;
        var texto;
        var actividades = [];
        var horas;
        var NombreSubservicio;
        var HorasSubservicio;
        var elemento;
        var dolar;
        var uf;
        var RefacturaIncremento;
        var RefacturaPorcentaje;
        var RefacturaCondicion;
        var totalUF;
        var itemservicio;
        var iteminfo;
        var totalserviciomensual = 0;



        function b64toBlob(b64Data, contentType, sliceSize) {
            contentType = contentType || '';
            sliceSize = sliceSize || 512;
            var byteCharacters = atob(b64Data);
            var byteArrays = [];
            for (var offset = 0; offset < byteCharacters.length; offset += sliceSize) {
                var slice = byteCharacters.slice(offset, offset + sliceSize);
                var byteNumbers = new Array(slice.length);
                for (var i = 0; i < slice.length; i++) {
                    byteNumbers[i] = slice.charCodeAt(i);
                }
                var byteArray = new Uint8Array(byteNumbers);
                byteArrays.push(byteArray);
            }
            var blob = new Blob(byteArrays, { type: contentType });
            return blob;
        }

        $('#cmbSubfamilia').attr('disabled', true);
        $('#cmbPlantilla').attr('disabled', true);

        _.each(ParametrosGenerales, function(i) {

            RefacturaIncremento = i.RefacturaIncremento
            RefacturaPorcentaje = i.RefacturaPorcentaje
            RefacturaCondicion = i.RefacturaCondicion

        });


        _.each(InfoSimulacion, function(i) {

            $('#pValorDolar').text(i.Dolar);
            $('#pValorUF').text(i.UF);
            $('#pDiaFacturacion').text(i.DiaFacturacion);
            $('#pFechaSimulacion').text(i.Fecha);

            dolar = i.Dolar;
            uf = i.UF;

        });

        contadorServicio = 0;

        _.each(Servicios,function(i) {

            contadorServicio++;
            $('#cmbServicio').append('<option value="'+ i.Idcatalogoservicio+'">'+i.Nombreservicio+' </option>');

        });

        _.each(_.sortBy(familiasJson,function (j) { return j.Familia.toLowerCase(); }), function(i) {

            if($('#cmbFamilia option[value=' + i.idFamilia + ']').length == 0) {

                $('#cmbFamilia').append('<option value="' + i.idFamilia + '">' + i.Familia + '</option>');

            }
        });

        $('#btn_nvo_serv').click(function () {


            var contadorServicio = $('#cmbServicio option').length;

            if(contadorServicio < 2)
            {
                alert('No existen servicios diponibles para este proyecto, comuniquese con el administrador.');
            }
            else
            {
                $('#modAgregServicio h4.modal-title').text('Agregar Servicio');
                $('#modAgregServicio')
                    .prop('class', 'modal fade')
                    .addClass('right')
                    .modal({
                        backdrop: 'static',
                        keyboard: false
                    });
                $('#modAgregServicio').modal('show');
                $(':input, a').attr('tabindex', '-1');
            }

        });

        $('#btn_nvo_comp').click(function () {


            $('#dmc_newArbol').empty();
            $('#cmbFamilia').val(-1);
            $('#cmbSubfamilia option').remove();
            $('#cmbPlantilla option').remove();
            $('#cmbSubfamilia').attr('disabled', true);
            $('#cmbPlantilla').attr('disabled', true);
            $('#dv_guardar').empty();

            $('#modComponente')
                .prop('class', 'modal fade')
                .addClass('right')
                .modal({
                    backdrop: 'static',
                    keyboard: false
                });
            $('#modComponente').modal('show');
            $(':input, a').attr('tabindex', '-1');


        });

        $('#modAgregServicio #btn_enviar').click(function () {


            var cantidad = $('#tbCantidad').val();
            var Mensual = $('#tbAgregarCantidadMensual').val();
            var descripcion = $('#tbDescripcion').val();
            var tiposervidor = $('#modAgregServicio').attr('tiposervicio');
            var tipomoneda = $('#sl_tipo_moneda').val();
            var valido = 1;
            var monto = 0;
            var costoInicial = 0;
            var costoMensual = 0;


            itemservicio = {};

            texto = '';

            if(tiposervidor == "1") {


                if($('#tbCantidad').length != 0 && $('#tbAgregarCantidadMensual').val() == '') {

                    valido = 0;

                }

                if($('#tbAgregarCantidadMensual').length != 0 && $('#tbAgregarCantidadMensual').val() == '') {

                    valido = 0;

                }

                if(valido == 1) {

                    _.each(_.where(Servicios, { Idcatalogoservicio: seleccion}), function(i) {

                        texto = '<tr ide="100" tiposervicio="1" class="tr-click">\
                                    <td>Servicio</td>\
                                    <td>' + i.Nombreservicio + '</td>\
                                    <td>-</td>';


                        if(i.Tipocobroinicial == '0') {

                            texto += '<td>0</td>';

                            itemservicio['CostoInicial'] = '0';

                        } if(i.Tipocobroinicial == '1') {

                            texto += '<td>' + i.Costounidadinicial + '</td>';

                            costoInicial = parseFloat($('#pCostoInicial').text().replace(',', '.'), 10) + parseFloat(i.Costounidadinicial.replace(',', '.'));
                            costoInicial = (costoInicial.toFixed(2) + '').replace('.', ',');
                            $('#pCostoInicial').text(costoInicial);

                            itemservicio['CostoInicial'] = i.Costounidadinicial.replace(',', '.');

                        } if(i.Tipocobroinicial == '2') {

                            monto = i.Costounidadinicial.replace(',', '.') * cantidad.replace(',', '.');

                            costoInicial = parseFloat($('#pCostoInicial').text(), 10) + parseFloat(monto);
                            costoInicial = (costoInicial + '').replace('.', ',');
                            $('#pCostoInicial').text(costoInicial);

                            monto = (monto.toFixed(2) + '').replace('.', ',');

                            texto += '<td>' + monto + '</td>';


                            itemservicio['CostoInicial'] = monto.replace(',', '.');

                        }

                        if(i.Tipocobromensual == '0') {

                            texto += '<td>0</td>';

                            itemservicio['CostoMensual'] = '0';

                        } if(i.Tipocobromensual == '1') {

                            texto += '<td>' + i.Costounidadmensual + '</td>';

                            costoMensual = parseFloat($('#pCostoMensual').text().replace(',', '.')) + parseFloat(i.Costounidadmensual.replace(',', '.'));
                            costoMensual = (costoMensual.toFixed(2) + '').replace('.', ',');
                            $('#pCostoMensual').text(costoMensual);

                            itemservicio['CostoMensual'] = i.Costounidadmensual.replace(',', '.');

                            totalserviciomensual += parseFloat(i.Costounidadmensual.replace(',', '.'))

                        } if(i.Tipocobromensual == '2') {

                            monto = i.Costounidadmensual.replace(',', '.') * Mensual.replace(',', '.');

                            costoMensual = parseFloat($('#pCostoMensual').text(), 10) + parseFloat(monto);
                            costoMensual = (costoMensual + '').replace('.', ',');
                            $('#pCostoMensual').text(costoMensual);

                            monto = (monto.toFixed(2) + '').replace('.', ',');

                            texto += '<td>' + monto + '</td>';

                            itemservicio['CostoMensual'] = monto.replace(',', '.');

                            totalserviciomensual += parseFloat(monto.replace(',', '.'))

                        }

                        $('#tblCotizacion tbody').append(texto);


                        itemservicio['Descripcion'] = i.Nombreservicio;
                        itemservicio['NombreSubservicio'] = '';
                        itemservicio['HorasSubservicio'] = '';

                    });

                    ServicioJson.push(itemservicio);

                }



            }

            if(tiposervidor == "2") {

                if(actividades != '') {

                    horas = 0;

                    _.each(actividades, function(i) {

                        horas += parseFloat(i.horas);

                    });


                    _.each(_.where(Servicios, { Idcatalogoservicio: seleccion}), function(i) {

                        $('#tblCotizacion tbody').append('<tr ide="100" idestado="1" tiposervicio="2" class="tr-click">\
                                                        <td>Servicio</td>\
                                                        <td>' + i.Nombreservicio + '</td>\
                                                        <td>-</td>\
                                                        <td>' + horas.toFixed(2) + '</td>\
                                                        <td>0</td>\
                                                      </tr>');


                        _.each(actividades, function(j) {

                            itemservicio = {};

                            itemservicio['Descripcion'] = i.Nombreservicio;
                            itemservicio['CostoMensual'] = '0';
                            itemservicio['CostoInicial'] = horas.toFixed(2).replace(',', '.');
                            itemservicio['NombreSubservicio'] = j.subservicio;
                            itemservicio['HorasSubservicio'] = j.horas.replace('.', ',');


                            ServicioJson.push(itemservicio);

                        });



                    });

                    costoInicial = parseFloat($('#pCostoInicial').text().replace(',', '.')) + parseFloat(horas);
                    costoInicial = (costoInicial.toFixed(2) + '').replace('.', ',');
                    $('#pCostoInicial').text(costoInicial);


                } else {

                    alert('Se deben ingresar actividades para guardar este servicio');

                }

                actividades = [];

            }

            if(tiposervidor == "3") {

                totalUF = 0;

                if($('#tbAgregarCantidadMensual').val() == '') {

                    valido = 0;

                }

                if(valido == 1) {


                    _.each(_.where(Servicios, { Idcatalogoservicio: seleccion}), function(i) {

                        texto = '<tr ide="100" tiposervicio="3" class="tr-click">\
                                    <td>Servicio</td>\
                                    <td>' + i.Nombreservicio + '</td>';


                        itemservicio['Descripcion'] = i.Nombreservicio;
                        itemservicio['CostoMensual'] = '0';
                        itemservicio['NombreSubservicio'] = '';
                        itemservicio['HorasSubservicio'] = '';

                    });

                    if($('#sl_tipo_moneda').val() == 'Dolar') {


                        totalUF = (parseFloat($('#tbAgregarCantidadMensual').val().replace(',', '.')) * parseFloat(dolar) / parseFloat(uf)).toFixed(2);



                    } else {

                        totalUF = parseFloat$('#tbAgregarCantidadMensual').val().replace(',', '.');

                    }


                    if(totalUF > RefacturaCondicion) {

                        totalUF = totalUF + RefacturaPorcentaje * totalUF + RefacturaIncremento;


                    } else {

                        totalUF = totalUF + RefacturaPorcentaje * totalUF;

                    }

                    totalUF = (parseFloat(totalUF).toFixed(2) + '').replace('.', ',');

                    texto += '<td>-</td>\
                                <td>' + totalUF + '</td>\
                                <td>0</td>\
                                </tr>';


                    $('#tblCotizacion tbody').append(texto);

                    costoInicial = parseFloat($('#pCostoInicial').text().replace(',', '.')) + parseFloat(parseFloat($('#tbAgregarCantidadMensual').val().replace(',', '.')) * parseFloat(dolar) / parseFloat(uf));
                    costoInicial = (costoInicial.toFixed(2) + '').replace('.', ',');
                    $('#pCostoInicial').text(costoInicial);


                    itemservicio['CostoInicial'] = totalUF.replace(',', '.');

                }

                ServicioJson.push(itemservicio);

            }


            $('#modAgregServicio').modal('toggle');
            $('#cmbServicio').val('0');
            $('#agregar_servicio_1').empty();
            $('#agregar_servicio_2').empty();
            $('#tab_horas').empty();


        });


        $('#cmbServicio').on('change', function() {

            seleccion = $("#cmbServicio").val();

            var idJson;
            var contador=0;



            _.each(Servicios,function(i) {

                if(i.Idcatalogoservicio == seleccion ) {

                    $('#modAgregServicio').attr('tiposervicio', i.Idtiposervicio);

                    $('#tab_horas').empty();
                    $('#agregar_servicio_1').empty();
                    $('#agregar_servicio_2').empty();
                    $('#agregar_servicio_enviar').empty();

                    if(i.Idtiposervicio == '1') {

                        $('#agregar_servicio_1').append('<div class="col-md-4 col-xs-4">\
                                                            <label id="lbDescripcion" class="control-label">Descripción:</label>\
                                                            <label id="lbDescripcionBot" class="control-label">  </label>\
                                                        </div>');

                        $('#lbDescripcionBot').text(i.Descripcion);



                        if(i.Tipocobroinicial == '1') {

                            $('#agregar_servicio_2').append('<div class="col-sm-4 col-xs-12">\
                                                                <label class="control-label">Costo Fijo</label>\
                                                                <label id="lbTipoUnidad" class="control-label">Costo Inicial : ' + i.Costounidadinicial + '</label>\
                                                            </div>');

                        }

                        if(i.Tipocobroinicial == '2') {

                            $('#agregar_servicio_2').append('<div class="col-sm-4 col-xs-12">\
                                                                <label id="lbTipoUnidad" class="control-label">Costo Inicial : ' + i.TipoUnidad + '</label>\
                                                                <input id="tbCantidad" type="text" size="9" maxlength="9" class="es-requerido solo-numero-coma form-control input-sm"/>\
                                                            </div>');

                        }

                        if(i.Tipocobromensual == '1') {

                            $('#agregar_servicio_2').append('<div class="col-sm-4 col-xs-12">\
                                                                <label class="control-label">Costo Fijo</label>\
                                                                <label id="lbTipoUnidadMensual" class="control-label">Costo Mensual : ' + i.Costounidadmensual + '</label>\
                                                            </div>');

                        }

                        if(i.Tipocobromensual == '2') {

                            $('#agregar_servicio_2').append('<div class="col-sm-4 col-xs-12">\
                                                                <label id="lbTipoUnidadMensual" class="control-label">Costo Mensual : ' + i.TipoUnidadMensual + '</label>\
                                                                <input id="tbAgregarCantidadMensual" type="text" size="9" maxlength="9" class="es-requerido solo-numero-coma form-control input-sm"/>\
                                                            </div>');

                        }

                    }

                    if(i.Idtiposervicio == '2') {



                        $('#agregar_servicio_1').append('<div class="col-md-4 col-xs-4">\
                                                            <label id="lbDescripcion" class="control-label">Descripción:</label>\
                                                            <label id="lbDescripcionBot" class="control-label">  </label>\
                                                        </div>');

                        $('#agregar_servicio_1').append('<div class="col-md-4 col-xs-4">\
                                                            <label id="lbHoras" class="control-label">Horas:</label>\
                                                            <label id="lbHorasTotales" class="control-label">0</label>\
                                                        </div>');

                        $('#lbDescripcionBot').text(i.Descripcion);



                        $('#tab_horas').append('<div class="row">\
                                                    <div class="col-md-3">\
                                                        <label class="control-label">\
                                                            Nombre Actividad :\
                                                        </label>\
                                                        <input id="actividad_in_nombre" class="form-control input-sm es-requerido" type="text" />\
                                                    </div>\
                                                    <div class="col-md-3">\
                                                        <label class="control-label">\
                                                            Horas Actividad :\
                                                        </label>\
                                                        <input id="actividad_in_horas" class="form-control input-sm es-requerido es-flotante solo-numero-coma" type="text" />\
                                                    </div>\
                                                    <div class="col-md-2 centrado">\
                                                        <label class="control-label">\
                                                        Agregar :\
                                                        </label>\
                                                        <span id="agregar_actividad" class="glyphicon glyphicon-plus icono" />\
                                                    </div>\
                                                </div>\
                                                <div class="row">\
                                                    <table id="tb_actividades" class="table table-hover table-striped">\
                                                        <thead>\
                                                            <tr>\
                                                                <th class="col-md-7">Nombre</th>\
                                                                <th class="col-md-3">Horas</th>\
                                                                <th class="col-md-2">Acción</th>\
                                                            </tr>\
                                                        </thead>\
                                                        <tbody></tbody>\
                                                    </table>\
                                                </div>');



                    }

                    if(i.Idtiposervicio == '3') {


                        $('#agregar_servicio_2').append('<div class="col-md-4">\
                                                            <label class="control-label">Unidad Monetaria</label>\
                                                            <select id="sl_tipo_moneda" class="input-sm form-control">\
                                                                <option value="Dolar">Dolar</option>\
                                                                <option value="UF">UF</option>\
                                                            </select>\
                                                        </div>\
                                                        <div class="col-sm-4 col-md-4">\
                                                            <label class="control-label">Valor</label>\
                                                            <input id="tbAgregarCantidadMensual" type="text" size="9" maxlength="9" class="es-requerido solo-numero-coma form-control input-sm"/>\
                                                        </div>');

                    }




                }
            });

        });


        $(document).on('click', '#agregar_actividad', function () {



            if($('#actividad_in_nombre').val() != '' && $('#actividad_in_horas').val() != '') {

                elemento = '';

                horas = parseFloat($('#actividad_in_horas').val().replace(',', '.')) + parseFloat($('#lbHorasTotales').text().replace(',', '.'));

                elemento += '<tr>\
                                    <td valoractual="' + $('#actividad_in_nombre').val() + '">'
                                        + $('#actividad_in_nombre').val() + '</td>\
                                    <td valoractual="' + $('#actividad_in_horas').val() + '">'
                                        + $('#actividad_in_horas').val() + '</td>\
                                    <td>';

                actividades.push({
                    idplantillasubservicio: '',
                    subservicio: $('#actividad_in_nombre').val(),
                    horas: $('#actividad_in_horas').val().replace(',', '.')}
                                    );


                if ('@User.IsInRole("OBSERVADOR")' == 'False')
                {
                    elemento += '<span class="glyphicon glyphicon-pencil"></span>\
                                        <span class="glyphicon glyphicon-trash"></span>\
                                        <span class="glyphicon glyphicon-ok" style="display: none;"></span>\
                                        <span class="glyphicon glyphicon-remove" style="display: none;"></span>';
                }

                elemento += '</td>\
                        </tr>';


                $('#tb_actividades tbody').prepend(elemento);

                $('#lbHorasTotales').text(horas);

                $('#actividad_in_nombre').val('');
                $('#actividad_in_horas').val('');

            }


        });


        $(document).on('click', '#modAgregServicio .glyphicon-trash',function(e) {

            NombreSubservicio = $(this).closest('td').siblings(':first-child').text();
            HorasSubservicio = $(this).closest('td').siblings(':nth-child(2)').text();
            horas = 0;

            temp = $(this).closest('tr');

            var callback = function () {

                temp.remove();

                actividades = _.reject(actividades, {
                    subservicio: NombreSubservicio
                });

                _.each(actividades, function(i) {

                    horas += parseFloat(i.horas);

                });

                $('#lbHorasTotales').text(horas);

            };

            confirm('', '¿Esta seguro que desea borrar este actividad?', 'Cancelar', 'Eliminar', callback);

        });


        $(document).on('click', '#modAgregServicio .glyphicon-pencil', function () {

            NombreSubservicio = $(this).closest('td').siblings(':first-child').text();
            HorasSubservicio = $(this).closest('td').siblings(':nth-child(2)').text();


            $(this).closest('td').find('.glyphicon-pencil').hide();
            $(this).closest('td').find('.glyphicon-trash').hide();
            $(this).closest('td').find('.glyphicon-ok').show();
            $(this).closest('td').find('.glyphicon-remove').show();

            elemento = '<input class="form-control input-sm" type="text" value="' + NombreSubservicio + '"/>';

            $(this).closest('td').siblings(':first-child').text('');
            $(this).closest('td').siblings(':first-child').append(elemento);


            elemento = '<input class="form-control input-sm" type="text" value="' + HorasSubservicio + '"/>';

            $(this).closest('td').siblings(':nth-child(2)').text('');
            $(this).closest('td').siblings(':nth-child(2)').append(elemento);

        });


        $(document).on('click', '#modAgregServicio .glyphicon-ok',function(e) {


            idsubservicio = $(this).attr('idsubservicio');
            horasservicio = 0;

            NombreSubservicio = $(this).closest('td').siblings(':first-child').find('input').val().trim();
            HorasSubservicio = $(this).closest('td').siblings(':nth-child(2)').find('input').val().trim();

            actividades = _.reject(actividades, {
                subservicio: NombreSubservicio
            });

            actividades.push({
                idplantillasubservicio: '',
                subservicio: NombreSubservicio,
                horas: HorasSubservicio
            });


            _.each(actividades, function(i) {

                horasservicio += parseFloat(horasservicio) + parseFloat((i.horas).replace(',', '.'));

            });


            $('#lbHorasTotales').text(horasservicio);

            $(this).closest('td').find('.glyphicon-pencil').show();
            $(this).closest('td').find('.glyphicon-trash').show();
            $(this).closest('td').find('.glyphicon-ok').hide();
            $(this).closest('td').find('.glyphicon-remove').hide();


            $(this).closest('td').siblings(':first-child').attr('valoractual', NombreSubservicio);
            $(this).closest('td').siblings(':nth-child(2)').attr('valoractual', HorasSubservicio);


            $(this).closest('td').siblings(':first-child').text('');
            $(this).closest('td').siblings(':first-child').append(NombreSubservicio);

            $(this).closest('td').siblings(':nth-child(2)').text('');
            $(this).closest('td').siblings(':nth-child(2)').append(HorasSubservicio);



        });

        $(document).on('click', '#modAgregServicio .glyphicon-remove',function(e) {

            NombreSubservicio = $(this).closest('td').siblings(':first-child').attr('valoractual');
            HorasSubservicio = $(this).closest('td').siblings(':nth-child(2)').attr('valoractual');

            $(this).closest('td').find('.glyphicon-pencil').show();
            $(this).closest('td').find('.glyphicon-trash').show();
            $(this).closest('td').find('.glyphicon-ok').hide();
            $(this).closest('td').find('.glyphicon-remove').hide();


            $(this).closest('td').siblings(':first-child').text('');
            $(this).closest('td').siblings(':first-child').append(NombreSubservicio);

            $(this).closest('td').siblings(':nth-child(2)').text('');
            $(this).closest('td').siblings(':nth-child(2)').append(HorasSubservicio);


        });


        $('#cmbFamilia').change(function() {
            
            var idFamilia = $(this).val();

           
            $('#cmbSubfamilia').html('');
            $('#cmbPlantilla').html('');

            if (idFamilia == -1) {

                $('#cmbSubfamilia').attr('disabled',true);
                $('#cmbPlantilla').attr('disabled',true);
                return;
            }

           

            $('#cmbSubfamilia').append('<option value="-1"></option>');
            var aux = "<select id='cmbSubfamilia' class='chosen-select'>";
            _.each(_.sortBy(_.where(familiasJson, {idFamilia : idFamilia}), function (j) { return j.Subfamilia.toLowerCase(); }), function(i){

                if($('#cmbSubfamilia option[value='+i.idSubFamilia+']').length == 0) {

                    $('#cmbSubfamilia').append('<option value="'+ i.idSubFamilia +'">'+i.Subfamilia+'</option>');
                    aux =  aux + '<option value="'+ i.idSubFamilia +'">'+i.Subfamilia+'</option>';
                }

                

            });
            aux = aux + "</select>";

          
            $('#cmbSubfamilia').html(aux);


            $('#cmbSubfamilia').attr('disabled',false);
            $('#cmbPlantilla').attr('disabled',true);
       
            //$('.chosen-select').chosen({width: "100%"});
        });

        $('#cmbSubfamilia').click(function() {

            var idSubfamilia = $(this).val();

            $('#cmbPlantilla').html('');

            if (idSubfamilia == -1) {

                $('#cmbSubfamilia').attr('disabled',false);
                $('#cmbPlantilla').attr('disabled',true);
                return;
            }

            $('#cmbPlantilla').append('<option value="-1"></option>');

            _.each(_.sortBy(_.where(familiasJson, {idSubFamilia : idSubfamilia}), function (j) { return j.Plantilla.toLowerCase(); }), function(i) {

                $('#cmbPlantilla').append('<option value="'+ i.Idplantilla +'">'+i.Plantilla+'</option>');

            });

            $('#cmbPlantilla').attr('disabled',false);
        });

        $('#cmbPlantilla').click(function(){

            var Idplantilla = $(this).val();

            if (Idplantilla == -1) {
                return;
            }

            //$('#dmc_newArbol').html("");

            var url = '@Html.Raw(Url.Action("vpCotizador", "Simulacion"))';
            url = url + '/' + Idplantilla;
            $('#dmc_newArbol').load(url);

        });

        $('#btn_rep').click(function () {

            var repURL;

            repURL = '@Url.Action("vpReporteSimulacion", "Simulacion")';

            $('#modReporteCot')
                .prop('class', 'modal fade')
                .addClass('right')
                .modal({
                    backdrop: 'static',
                    keyboard: false
                });


            $('#modReporteCot').modal('show');
            $(':input, a').attr('tabindex', '-1');

            MontoServicioJson = [];

            itemservicio = {};

            itemservicio['CostoInicial'] = $('#pCostoInicial').text().replace(',', '.');
            itemservicio['CostoMensual'] = totalserviciomensual.toFixed(2);

            MontoServicioJson.push(itemservicio);


            InfoSimulacion = [];

            iteminfo = {};

            iteminfo['Usuario'] = '@ViewBag.usuario';
            iteminfo['Fecha'] = $('#pFechaSimulacion').text();
            iteminfo['USD'] = $('#pValorDolar').text();
            iteminfo['UF'] = $('#pValorUF').text();

            InfoSimulacion.push(iteminfo);
            console.log(InfoSimulacion);
            $.ajax({
                type: 'POST',
                url: '@Url.Action("vpReporteSimulacion", "Simulacion")',
                data: {
                    componenteJson : JSON.stringify(ComponenteJson),
                    servicioJson : JSON.stringify(ServicioJson),
                    montoservicioJson : JSON.stringify(MontoServicioJson),
                    infosimulacionJson : JSON.stringify(InfoSimulacion)},
                success: function(html) {

                    $('#vpmRep').html(html);
                }
            });


        });

        $('#btn_pdf').click(function() {


            var repURL;

            repURL = '@Url.Action("ReporteSolicitudRetiro", "Simulacion")';


            $.ajax({
                type: "POST",
                url: repURL,
                data: {
                    componenteJson : JSON.stringify(ComponenteJson),
                    servicioJson : JSON.stringify(ServicioJson),
                    montoservicioJson : JSON.stringify(MontoServicioJson)}
            }).done(function (err) {

                var blob = b64toBlob(err, "data:application/pdf;");
                saveAs(blob, 'Simulacion Cotizacion.pdf');
            });

        });

    });

</script>


<style>

    th {
        vertical-align: bottom;
        border-bottom: 2px solid #ddd;
    }

    .grilla thead{
    color: #8FBE00;
    font-weight: bold;
    cursor: default;
}

    .grilla span{
        cursor: pointer;
    }

    .grilla span:hover{
        color: #8FBE00;
    }

    .icono{
        cursor: pointer;
        border:none;
    }

</style>



    <div class="container-fluid">

        <div class="row">
            <div class="col-md-6 col-sm-6">
                <h3 id="ttl">Reporte Simulación Cotización</h3>
            </div>
        </div>

        <div class="row">

            <div class="form-group col-md-2">
                <label class="">Costo Inicial</label>
                <p id="pCostoInicial" class="form-control-static">0</p>
            </div>

            <div class="form-group col-md-2">
                <label class="">Costo Mensual</label>
                <p id="pCostoMensual" class="form-control-static">0</p>
            </div>

            <div class="form-group col-md-2">
                <label class="">Valor Dolar</label>
                <p id="pValorDolar" class="form-control-static"></p>
            </div>

            <div class="form-group col-md-2">
                <label class="">Valor UF</label>
                <p id="pValorUF" class="form-control-static"></p>
            </div>

            <div class="form-group col-md-2">
                <label class="">Dia de Facturación</label>
                <p id="pDiaFacturacion" class="form-control-static"></p>
            </div>

            <div class="form-group col-md-2">
                <label class="">Fecha Simulación</label>
                <p id="pFechaSimulacion" class="form-control-static"></p>
            </div>

        </div>
        
        <div class="row">
            <div class="col-md-12 col-sm-12">
                <div style="border-top:solid 2px #8FBE00;"></div>
            </div>
        </div>

        <div class="row">
            <table id="tblCotizacion" class="table table-responsive table-striped table-hover grilla">
                <thead>
                    <tr>
                        <th class="col-md-2">Tipo</th>
                        <th class="col-md-4">Descripción</th>
                        <th class="col-md-2">Plantilla</th>
                        <th class="col-md-2">Monto Inicial UF</th>
                        <th class="col-md-2">Monto Mensual UF</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

    </div>


    <div class="container-fluid">

        <div class="row" style="background-color:#F9F9F9;height:28px;">
            <div class="col-md-12">
                <div class="btn-group pull-right" role="group">


                    <button id="btn_nvo_comp" type="button" class="btn btn-default" title="Nuevo Componente" style="border:none;background-color:#F9F9F9;"><i class="fa fa-plus"></i></button>
                    <button id="btn_nvo_serv" type="button" class="btn btn-default" title="Nuevo Servicio" style="border:none;background-color:#F9F9F9;"><i class="fa fa-suitcase"></i></button>
                    <button id="btn_rep" type="button" class="btn btn-default" title="Reporte" style="border:none;background-color:#F9F9F9;"><i class="fa fa-file-text-o"></i></button>

                </div>
            </div>
        </div>

    </div>



    <div class="row">

        <div class="modal fade" id="modAgregServicio" tiposervicio="">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">

                    <div class="modal-header ttl_modal">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                        <h4 class="modal-title">Agregar Servicio</h4>
                    </div>

                    <div id="nvo_servicio" class="modal-body modal-scroll">

                        <div class="container-fluid">

                            <div class="row">

                                <div class="col-md-4 col-xs-4">
                                    <label id="lbCmbServicio" class="control-label">Seleccione un Servicio</label>

                                    <select id="cmbServicio" class="chosen-select">
                                        <option selected disabled value="0">Seleccione un Servicio</option>
                                    </select>

                                </div>
         
                                <div id="agregar_servicio_1"></div>



                            </div>

                            <div class="row">

                                <div id="agregar_servicio_2"></div>

                            </div>

                            <div id="tab_horas"></div>

                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>

                        <button id="btn_enviar" type="submit" class="btn btn-primary">Agregar</button>
                    </div>

                </div>
            </div>
        </div>
    </div>
    <!-- /.modal agregar servicio -->
    

    <!-- /.modal-->
    <div class="modal fade" id="modComponente">
        <div class="modal-dialog modal-lg" id="modDialog">
            <div class="modal-content">
                <div class="modal-header ttl_modal">
                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                    <h4 class="modal-title">Agregar Componente</h4>
                </div>
                <div class="modal-body ui-front">

                    <div class="row">
                        <div class="col-md-3">
                            <label class="control-label">Familia</label>
                            <select id="cmbFamilia" class="form-control input-sm"><option value="-1"></option></select>
                        </div>
                        <div class="col-md-3">
                            <label class="control-label">Subfamilia</label>
                            <select id="cmbSubfamilia" class="form-control input-sm"></select>
                        </div>
                        <div class="col-md-3">
                            <label class="control-label">Plantilla</label>
                            <select id="cmbPlantilla" class="form-control input-sm"></select>
                        </div>
                    </div>

                    <div class="row">
                        <div id="dmc_newArbol"></div>
                    </div>

                </div>
                <div id="dv_guardar" class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
    <!-- /.modal end -->

    <!-- /.modal Reporte Cotizacion -->
    <div class="modal fade" id="modReporteCot">
        <div class="modal-dialog" style="width:80%;">
            <div class="modal-content">

                <div class="modal-header ttl_modal">
                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                    <div class="row">
                        <div class="col-md-4">
                            <h4 class="modal-title">Reporte</h4>
                        </div>
                        <div id="ico_carga" class="col-md-6"></div>
                    </div>
                </div>

                <div id="upd_servicio" data-id="" class="modal-body ui-front alert alert-warning text-center">
                    <div id="vpmRep"></div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>
                    <button id="btn_pdf" type="button" class="btn btn-primary">PDF</button>
                </div>

            </div>
        </div>
    </div>
    <!-- /.modal Reporte Cotizacion -->

<script>
    $(document).ready(function(){
        $('.chosen-select').chosen({width: "100%"});
    });

</script>